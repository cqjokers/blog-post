---
title: JAVA类加载机制
date: 2018-07-30
categories:
- java
---
![](https://upload-images.jianshu.io/upload_images/13023122-65d6e90207ca50b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)类从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期包括：加载、验证、准备、解析、初始化、卸载7个阶段。类的加载过程必须按照这种顺序按部就班地开始，而解析阶段则不一定：它在某些情况下可以在初始化阶段之后再开始,这是为了支持Java语言语言的运行时绑定（也叫动态绑定和晚期绑定）。 
## 加载
在加载阶段,虚拟机需要完成以下3件事情:
* 通过一个类的全限定名来获取此定义类的二进制字节流;
* 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构;
* 在内存中生在一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据访问的入口。
一个非数组类的加载阶段是开发人员可控性最强的，因为加载阶段既可以使用系统提供的引导类加载器来完成，也可以由用户自定义的类加载器去完成(即重写一个类加载器的loadClass()方法)。数组类本身不通过类加载器创建，它是由JVM直接创建的。但数组类和类加载器仍有很紧密的关系，因为数组类的元素类型最终是靠类加载器去创建。 
加载阶段完成后，虚拟机外部的二进制字节流就按照虚拟机所需的格式存储在方法区之中，方法区中的数据存储格式由虚拟机实现自行定义。然后在内存中实例化一个java.lang.Classo类的对象作为程序访问方法区中的这些类型数据的外部接口。
加载阶段与连接阶段的部分内容（如一部分字节码文件格式验证动作）是交叉进行的，加载阶段尚未结束，连接阶段就可能开始了。但是夹在加载阶段进行的动作，仍然属于连接阶段的内容。
<!--more-->
## 验证
验证是连接的第一步，这一阶段的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危及虚拟机本身的安全。 验证阶段是非常重要的，这个阶段是否严谨，直接决定了JAVA虚拟机是否能承受恶意代码的攻击。验证阶段大致分为4个阶段的校验动作：文件格式验证
、元数据验证、字节码验证、符号引用验证。
* 文件格式验证：
	验证字节流是否符合Class文件格式的规范，并且能被当前版本的虚拟机处理。验证点主要有：是否以魔数(0xCAFEBABE)开关、主/次版本号是否在当前虚拟机处理范围内、常量池的常量中是否有不被支持的常量类型、指向常量的各种索引值中是否有指向不存在的常量或不符合类型的常量等其它验证点
	该阶段的主要目的是保证输入的字节流能正确地解析并存储于方法区之内，这阶段的验证是基于二进制字节流进行的，只有通过了这个阶段的验证后，字节流才会进入内存的方法区中进行存储，所以后面的3个验证阶段全部是基于方法区的存储结构进行的，不会再直接操作字节流。
* 元数据验证：
	这一阶段是对字节码描述的信息进行语义分析，以保证其描述的信息符合JAVA语言规范。验证点包括：这个类是否有父类(Object不算)、这个类父类是否继承了不允许被继承的类(final修饰的类)、这个类不是抽象类，是否实现了其父类或接口之中要求实现的所有方法、类中的方法/字段是否与父类产生矛盾
	这一阶段的主要目的是对类的元数据信息进行语义分校验，保证不存在不符合JAVA语言规范的元数据信息。
* 字节码验证：
	通过数据流与控制流分析，确定程序语义是合法的、符合逻辑的。这一阶段主要是对类的方法体进行校验分析，保证被校验类的方法在运行时不会做出危害虚拟机的安全事件。校验点有：保证跳转指令不会跳转到方法体以外的字节码指令上、保证方法体中的类型转换是有效的
	如果一个类方法体的字节码没有通过字节验证，那肯定是有问题的；但如果一个方法体通过了字节码验证，也不能说明其一定就是安全的。
* 符号引用验证:
	这一阶段的验证发生在虚拟机将符号引用转化为直接引用的时候，这个转化动作将在连接的第三阶段--解析阶段发生。符号引用验证可以看做是对类自身以外(常量池中的各种引用)的信息进行匹配性校验，通常需要校验下我内容：符号引用中通过字符串描述的全限定名是否能找到对应的类、在指定类中是否存在符合方法的字段描述符以及简单名称所描述的方法和字段、符号引用中的类、字段、方法的访问性是否可被当前类访问等
	符号引用验证的目的是确保解析动作能正常执行，如果无法通过符号引用验证，那么将会抛出一个java.lang.IncompatibleClassChangeError异常的子类，如IllegalAccessError、NoSuchfiledError、NoSuchMethodError等。
## 准备
准备阶段是正式为类变量分配内存并设置类变量初始值的阶段，这些变量所使用的内存都将在方法区中进行分配。这个时候进行内存分配的仅包括类变量(被static修饰的变量), 而不包括实例变量，实例变量将会在对象实例化时随着对象一起分配置到java堆中。
## 解析
解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程。
* 符号引用：符号引用以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可。
* 直接引用: 直接引用可以是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄。
解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符7类符号引用进行。分别对应于常量池的CONSTANT_Class_info、CONSTANT_Fieldref_info、CONSTANT_Methodref_info、CONSTANT_InterfaceMethodref_info、CONSTANT_MethodType_info、CONSTANT_MethodHandle_info和CONSTANT_InvokeDynamic_info7种常量。
## 初始化
类初始化阶段是类加载过程的最后一步，前面的类加载过程中，除了在加载阶段用户应用程序可以通过自定义类加载器参与之外，其余动作完全由虚拟机主导和控制。到了初始化阶段，才真正开始执行类中定义的JAVA程序代码。
参考：深入理解JAVA虚拟机第二版